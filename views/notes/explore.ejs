<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="/styles/style.css" />
    <title>NotesPedia</title>
  </head>
  <body>
    <%- include("../includes/commonNav.ejs") %> <%-
    include("../includes/flash.ejs")%>;
    <div class="row mt-3">
        <div class="col-8 offset-3">
          <h3><%=allListing.title%></h3>
        </div>
        <div class="card col-4 offset-3 show-card listing-card">
          <img
            src="../images/notes.jpg"
            class="card-img-top show-img"
            alt="listing_image"
            height="height:40px"
          />
        </div>


    <div class="row offset-3 mt-2">
        <div class="col-8">
            <p class="card-text">
                üßë‚ÄçüíºOwned By:-<i><b><%= allListing.owner %></b></i><br>
              </p>

              <p>
                <%= allListing.desc %>
              </p>
              <!-- <a href="<%= allListing.fileUrl.url %>" download="<%= allListing.fileUrl.filename %>" target="_blank"><button class="btn btn-danger">Download Notes..</button></a> -->
              <button id="download-btn" class="btn btn-danger">Download Note @ ‚Çπ9  </button><span class="text-danger"><b>&nbsp &nbsp ** Note:After pay Download notes once Back Closed, You have to Pay again..</b></span>
        </div>
    </div>


  <!-- Razorpay Checkout Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
    document.getElementById("download-btn").onclick = function() {
      fetch(`/createOrder/<%= allListing._id %>`, {
        method: "POST",
      })
        .then((response) => response.json())
        .then((order) => {
          var options = {
            key: "<%= process.env.RAZORPAY_KEY_ID %>",
            amount: order.amount,
            currency: order.currency,
            name: "NotesPedia",
            description: "Download Note",
            order_id: order.id,
            handler: function(response) {
              fetch(`/verifyPayment`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  order_id:response.razorpay_order_id, 
                  payment_id: response.razorpay_payment_id,
                  signature: response.razorpay_signature,
                }),
              })
                .then((res) => res.json())
                .then((data) => {
                  if (data.success) {
                    window.location.href = `/downloadNote/<%= allListing._id %>`;
                  } else {
                    alert("Payment failed. Please try again.");
                  }
                });
            },
            prefill: {
              name: "<%= currUser ? currUser.username : '' %>",
              email: "<%= currUser ? currUser.email : '' %>",
            },
            theme: {
              color: "#3399cc",
            },
          };
          var rzp = new Razorpay(options);
          rzp.open();
        });
    };
  </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
